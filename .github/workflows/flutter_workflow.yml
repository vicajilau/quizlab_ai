name: Flutter CI
on:
  push:
    branches:
      - feature/github-action-update
  workflow_dispatch:

  # pull_request:
  #   branches:
  #     - main

jobs:
  flutter_ci:
    name: Run flutter test and analyze
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repositoy
        uses: actions/checkout@v5

      - name: Install flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"

      - name: Prepare repository
        uses: Spaccesi/flutter-actions-suite/prepare@main
        with:
          run-build-runner: 'false' 
          run-gen-l10n: 'true'
          gen-l10n-fails-if-untranslated: 'true'

      - name: Check repository
        uses: Spaccesi/flutter-actions-suite/check@main
        with:
          run-license: 'true'
          compatible-licenses-conf-path: '.github/licenses_checker.yaml'

      - name: Check license headers
        run: |
          MISSING_HEADERS=$(find lib test -name "*.dart" ! -name "*.g.dart" ! -name "*.freezed.dart" ! -name "*.mocks.dart" ! -name "app_localizations*.dart" -exec sh -c '! grep -q "^// Copyright (C) 2026 Víctor Carreras" "$1" && echo "$1"' _ {} \;)
          if [ -n "$MISSING_HEADERS" ]; then
            echo "❌ The following files are missing the GPL-3.0 license header:"
            echo "$MISSING_HEADERS"
            exit 1
          else
            echo "✅ All files have the correct GPL-3.0 license header."
          fi

      - name: Upload prepared workspace
        uses: actions/upload-artifact@v4
        with:
          name: prepared-repo
          path: |
            .
            !.git
          retention-days: 1
