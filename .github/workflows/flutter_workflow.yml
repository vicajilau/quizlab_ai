name: Flutter CI
on:
  push:
    branches:
      - main
  workflow_dispatch:

  pull_request:
    branches:
      - main

jobs:
  flutter_ci:
    name: Run flutter test and analyze
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: actions/setup-java@v4
        with:
          distribution: "zulu"
          java-version: "12"
      - uses: subosito/flutter-action@v2
        with:
          channel: "stable"
      - run: flutter pub get
      - run: flutter analyze
      - run: flutter test
      - name: Generate localizations
        run: flutter gen-l10n
      - name: Check for untranslated messages
        run: |
          content=$(cat untranslated_messages.json)
          if [ "$content" = "{}" ]; then
            echo "✅ All translations are complete!"
          else
            echo "❌ Found untranslated messages:"
            cat untranslated_messages.json
            echo ""
            echo "Please add the missing translations to the corresponding .arb files"
            exit 1
          fi
      - name: Check license headers
        run: |
          MISSING_HEADERS=$(find lib test -name "*.dart" ! -name "*.g.dart" ! -name "*.freezed.dart" ! -name "*.mocks.dart" ! -name "app_localizations*.dart" -exec sh -c '! grep -q "^// Copyright (C) 2026 Víctor Carreras" "$1" && echo "$1"' _ {} \;)
          if [ -n "$MISSING_HEADERS" ]; then
            echo "❌ The following files are missing the GPL-3.0 license header:"
            echo "$MISSING_HEADERS"
            exit 1
          else
            echo "✅ All files have the correct GPL-3.0 license header."
          fi
